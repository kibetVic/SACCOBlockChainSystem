@{
    ViewData["Title"] = "Loan Statement";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var loan = ViewBag.Loan as SACCOBlockChainSystem.Models.Loan;
    var schedule = ViewBag.Schedule as List<SACCOBlockChainSystem.Models.DTOs.LoanScheduleDTO>;
    var repayments = ViewBag.Repayments as List<SACCOBlockChainSystem.Models.LoanRepayment>;
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a asp-action="Details" asp-route-loanNo="@loan?.LoanNo" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i> Back to Loan
                </a>
                <h2 class="page-title mb-0">
                    <i class="bi bi-file-text me-2"></i>Loan Statement
                </h2>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" onclick="downloadStatement()">
                    <i class="bi bi-file-pdf me-2"></i>Download PDF
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statement Header -->
<div class="row mb-4" id="statementContent">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <!-- Company Header -->
                <div class="text-center mb-4 border-bottom pb-3">
                    <h2 class="mb-0">@User.FindFirst("CompanyName")?.Value</h2>
                    <p class="text-muted mb-0">Loan Statement</p>
                    <p class="text-muted">Generated on @DateTime.Now.ToString("dd MMMM yyyy HH:mm")</p>
                </div>

                <!-- Loan Summary -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Loan Information</h5>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td width="150">Loan Number:</td>
                                <td><strong>@loan?.LoanNo</strong></td>
                            </tr>
                            <tr>
                                <td>Loan Type:</td>
                                <td>@loan?.LoanType?.LoanType1</td>
                            </tr>
                            <tr>
                                <td>Disbursement Date:</td>
                                <td>@loan?.DisbursementDate?.ToString("dd MMM yyyy")</td>
                            </tr>
                            <tr>
                                <td>Maturity Date:</td>
                                <td>@loan?.MaturityDate?.ToString("dd MMM yyyy")</td>
                            </tr>
                            <tr>
                                <td>Interest Rate:</td>
                                <td>@(loan?.InterestRate * 100)% p.a.</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Member Information</h5>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td width="150">Member Number:</td>
                                <td><strong>@loan?.MemberNo</strong></td>
                            </tr>
                            <tr>
                                <td>Member Name:</td>
                                <td>@loan?.Member?.Surname @loan?.Member?.OtherNames</td>
                            </tr>
                            <tr>
                                <td>ID Number:</td>
                                <td>@loan?.Member?.Idno</td>
                            </tr>
                            <tr>
                                <td>Phone:</td>
                                <td>@loan?.Member?.PhoneNo</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Loan Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="border p-3 text-center">
                            <span class="text-muted">Principal Amount</span>
                            <h4 class="mb-0">KES @loan?.PrincipalAmount.ToString("N2")</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border p-3 text-center">
                            <span class="text-muted">Total Repaid</span>
                            <h4 class="mb-0 text-success">KES @(loan?.DisbursedAmount - loan?.OutstandingPrincipal)?.ToString("N2")</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border p-3 text-center">
                            <span class="text-muted">Outstanding</span>
                            <h4 class="mb-0 text-warning">KES @loan?.TotalOutstanding.ToString("N2")</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border p-3 text-center">
                            <span class="text-muted">Loan Status</span>
                            <h4 class="mb-0">@await Html.PartialAsync("_LoanStatusBadge", loan?.LoanStatus)</h4>
                        </div>
                    </div>
                </div>

                <!-- Transaction History -->
                <h5 class="mb-3">Transaction History</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Receipt No</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">Principal</th>
                                <th class="text-end">Interest</th>
                                <th class="text-end">Penalty</th>
                                <th class="text-end">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Disbursement -->
                            <tr class="table-primary">
                                <td>@loan?.DisbursementDate?.ToString("dd/MM/yyyy")</td>
                                <td>Loan Disbursement</td>
                                <td>-</td>
                                <td class="text-end text-success">@loan?.DisbursedAmount.ToString("N2")</td>
                                <td class="text-end">@loan?.DisbursedAmount.ToString("N2")</td>
                                <td class="text-end">0.00</td>
                                <td class="text-end">0.00</td>
                                <td class="text-end fw-bold">@loan?.DisbursedAmount.ToString("N2")</td>
                            </tr>

                            <!-- Repayments -->
                            @if (repayments != null)
                            {
                                var runningBalance = loan?.DisbursedAmount ?? 0;
                                @foreach (var repayment in repayments.OrderBy(r => r.PaymentDate))
                                {
                                    runningBalance -= (repayment.PrincipalAllocated + repayment.InterestAllocated + repayment.PenaltyAllocated);
                                    <tr>
                                        <td>@repayment.PaymentDate.ToString("dd/MM/yyyy")</td>
                                        <td>Loan Repayment (@repayment.PaymentMethod)</td>
                                        <td>@repayment.ReceiptNo</td>
                                        <td class="text-end">@repayment.AmountPaid.ToString("N2")</td>
                                        <td class="text-end">@repayment.PrincipalAllocated.ToString("N2")</td>
                                        <td class="text-end">@repayment.InterestAllocated.ToString("N2")</td>
                                        <td class="text-end">@repayment.PenaltyAllocated.ToString("N2")</td>
                                        <td class="text-end fw-bold">@runningBalance.ToString("N2")</td>
                                    </tr>
                                }
                            }
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <th colspan="3">Totals</th>
                                <th class="text-end">@repayments?.Sum(r => r.AmountPaid).ToString("N2")</th>
                                <th class="text-end">@repayments?.Sum(r => r.PrincipalAllocated).ToString("N2")</th>
                                <th class="text-end">@repayments?.Sum(r => r.InterestAllocated).ToString("N2")</th>
                                <th class="text-end">@repayments?.Sum(r => r.PenaltyAllocated).ToString("N2")</th>
                                <th class="text-end">@loan?.TotalOutstanding.ToString("N2")</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Payment Schedule Summary -->
                <h5 class="mb-3 mt-4">Payment Schedule Summary</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                                <th class="text-end">Principal</th>
                                <th class="text-end">Interest</th>
                                <th class="text-end">Total</th>
                                <th class="text-end">Paid</th>
                                <th class="text-end">Outstanding</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var paidInstallments = schedule?.Where(s => s.Status == "Paid").ToList();
                                var pendingInstallments = schedule?.Where(s => s.Status == "Pending").ToList();
                                var overdueInstallments = schedule?.Where(s => s.Status == "Overdue").ToList();
                            }
                            <tr>
                                <td><span class="badge bg-success">Paid</span></td>
                                <td>@paidInstallments?.Count</td>
                                <td class="text-end">@paidInstallments?.Sum(s => s.PrincipalAmount).ToString("N2")</td>
                                <td class="text-end">@paidInstallments?.Sum(s => s.InterestAmount).ToString("N2")</td>
                                <td class="text-end">@paidInstallments?.Sum(s => s.TotalInstallment).ToString("N2")</td>
                                <td class="text-end">@paidInstallments?.Sum(s => s.PaidAmount).ToString("N2")</td>
                                <td class="text-end">0.00</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-warning">Pending</span></td>
                                <td>@pendingInstallments?.Count</td>
                                <td class="text-end">@pendingInstallments?.Sum(s => s.PrincipalAmount).ToString("N2")</td>
                                <td class="text-end">@pendingInstallments?.Sum(s => s.InterestAmount).ToString("N2")</td>
                                <td class="text-end">@pendingInstallments?.Sum(s => s.TotalInstallment).ToString("N2")</td>
                                <td class="text-end">@pendingInstallments?.Sum(s => s.PaidAmount).ToString("N2")</td>
                                <td class="text-end">@pendingInstallments?.Sum(s => s.OutstandingAmount).ToString("N2")</td>
                            </tr>
                            <tr>
                                <td><span class="badge bg-danger">Overdue</span></td>
                                <td>@overdueInstallments?.Count</td>
                                <td class="text-end">@overdueInstallments?.Sum(s => s.PrincipalAmount).ToString("N2")</td>
                                <td class="text-end">@overdueInstallments?.Sum(s => s.InterestAmount).ToString("N2")</td>
                                <td class="text-end">@overdueInstallments?.Sum(s => s.TotalInstallment).ToString("N2")</td>
                                <td class="text-end">@overdueInstallments?.Sum(s => s.PaidAmount).ToString("N2")</td>
                                <td class="text-end">@overdueInstallments?.Sum(s => s.OutstandingAmount).ToString("N2")</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Footer -->
                <div class="mt-5 pt-3 border-top">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="text-muted small mb-0">
                                <i class="bi bi-shield-check me-1"></i>
                                @if (!string.IsNullOrEmpty(loan?.BlockchainTxId))
                                {
                                    <span>Verified on Blockchain: @loan.BlockchainTxId</span>
                                }
                                else
                                {
                                    <span>Not recorded on blockchain</span>
                                }
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <p class="text-muted small mb-0">
                                Generated by: @User.Identity?.Name<br>
                                @DateTime.Now.ToString("dd MMMM yyyy HH:mm:ss")
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        function downloadStatement() {
            var element = document.getElementById('statementContent');
            var opt = {
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: 'Loan_Statement_@(loan?.LoanNo).pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
    </script>
}