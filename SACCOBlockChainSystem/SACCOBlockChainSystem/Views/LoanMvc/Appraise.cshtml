@model SACCOBlockChainSystem.Models.DTOs.LoanAppraisalDTO
@{
    ViewData["Title"] = "Loan Appraisal";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var loan = ViewBag.Loan as SACCOBlockChainSystem.Models.Loan;
    var member = ViewBag.Member as SACCOBlockChainSystem.Models.Member;
}

@section Styles {
    <style>
        .score-meter {
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }
        .risk-high {
            background-color: #dc3545;
            color: white;
        }
        .risk-medium {
            background-color: #ffc107;
            color: black;
        }
        .risk-low {
            background-color: #28a745;
            color: white;
        }
    </style>
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center">
            <a asp-action="Details" asp-route-loanNo="@Model.LoanNo" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i> Back to Loan
            </a>
            <h2 class="page-title mb-0">
                <i class="bi bi-clipboard-check me-2"></i>Loan Appraisal
            </h2>
        </div>
    </div>
</div>

<div class="row">
    <!-- Add this after the breadcrumb section or at the top of the content area -->
    @if (ViewBag.SuccessMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            @ViewBag.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @ViewBag.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Left Column - Loan Information -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Loan Information</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Loan Number:</span>
                    <strong>@loan?.LoanNo</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Applied Amount:</span>
                    <strong class="text-primary">KES @loan?.PrincipalAmount.ToString("N2")</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Loan Type:</span>
                    <span>@loan?.LoanType?.LoanType1</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Interest Rate:</span>
                    <span>@(loan?.InterestRate * 100)% p.a.</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Repayment Period:</span>
                    <span>@loan?.RepaymentPeriod months</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Member:</span>
                    <strong>@member?.Surname @member?.OtherNames</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Member No:</span>
                    <span>@member?.MemberNo</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Share Capital:</span>
                    <span>KES @(member?.ShareCap?.ToString("N2") ?? "0.00")</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Monthly Contribution:</span>
                    <span>KES @(member?.MonthlyContr?.ToString("N2") ?? "0.00")</span>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Credit Assessment</h5>
            </div>
            <div class="card-body text-center">
                <div class="score-meter" id="creditScoreMeter"></div>
                <h3 class="mt-3" id="creditScore">-</h3>
                <p class="text-muted" id="creditRating">-</p>
            </div>
        </div>
    </div>

    <!-- Right Column - Appraisal Form -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Appraisal Form</h5>
            </div>
            <div class="card-body">
                <form asp-action="Appraise" method="post" id="appraisalForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="LoanNo" />
                    <input type="hidden" asp-for="CompanyCode" />
                    <input type="hidden" asp-for="AppraisedBy" />

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <!-- Financial Assessment -->
                    <h6 class="text-uppercase text-muted mb-3">Financial Assessment</h6>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label asp-for="MemberSharesValue" class="form-label">Member Shares Value</label>
                            <div class="input-group">
                                <span class="input-group-text">KES</span>
                                <input asp-for="MemberSharesValue" class="form-control" type="number" step="0.01" />
                            </div>
                            <span asp-validation-for="MemberSharesValue" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="MemberDepositsValue" class="form-label">Member Deposits Value</label>
                            <div class="input-group">
                                <span class="input-group-text">KES</span>
                                <input asp-for="MemberDepositsValue" class="form-control" type="number" step="0.01" />
                            </div>
                            <span asp-validation-for="MemberDepositsValue" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="MonthlyIncome" class="form-label">Monthly Income</label>
                            <div class="input-group">
                                <span class="input-group-text">KES</span>
                                <input asp-for="MonthlyIncome" class="form-control" type="number" step="0.01" required />
                            </div>
                            <span asp-validation-for="MonthlyIncome" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="ExistingLoanObligations" class="form-label">Existing Loan Obligations</label>
                            <div class="input-group">
                                <span class="input-group-text">KES</span>
                                <input asp-for="ExistingLoanObligations" class="form-control" type="number" step="0.01" />
                            </div>
                            <span asp-validation-for="ExistingLoanObligations" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Recommendation -->
                    <h6 class="text-uppercase text-muted mb-3">Appraisal Decision</h6>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label asp-for="AppraisalDecision" class="form-label">Decision</label>
                            <select asp-for="AppraisalDecision" class="form-select" required id="decisionSelect">
                                <option value="">-- Select Decision --</option>
                                <option value="Recommend">Recommend for Approval</option>
                                <option value="CounterOffer">Counter Offer</option>
                                <option value="NotRecommend">Not Recommend</option>
                            </select>
                            <span asp-validation-for="AppraisalDecision" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="RecommendedAmount" class="form-label">Recommended Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">KES</span>
                                <input asp-for="RecommendedAmount" class="form-control" type="number" step="0.01" />
                            </div>
                            <small class="text-muted">Max: KES @ViewBag.MaxLoanAmount?.ToString("N2")</small>
                            <span asp-validation-for="RecommendedAmount" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="RecommendedInterestRate" class="form-label">Recommended Interest Rate</label>
                            <div class="input-group">
                                <input asp-for="RecommendedInterestRate" class="form-control" type="number" step="0.01" />
                                <span class="input-group-text">%</span>
                            </div>
                            <span asp-validation-for="RecommendedInterestRate" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="RecommendedPeriod" class="form-label">Recommended Period</label>
                            <div class="input-group">
                                <input asp-for="RecommendedPeriod" class="form-control" type="number" min="1" />
                                <span class="input-group-text">months</span>
                            </div>
                            <span asp-validation-for="RecommendedPeriod" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Risk Assessment -->
                    <h6 class="text-uppercase text-muted mb-3">Risk Assessment</h6>

                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label asp-for="RiskFactors" class="form-label">Risk Factors</label>
                            <textarea asp-for="RiskFactors" class="form-control" rows="3"
                                      placeholder="Identify any risk factors"></textarea>
                            <span asp-validation-for="RiskFactors" class="text-danger"></span>
                        </div>
                        <div class="col-12">
                            <label asp-for="MitigationFactors" class="form-label">Mitigation Factors</label>
                            <textarea asp-for="MitigationFactors" class="form-control" rows="3"
                                      placeholder="Describe how risks are mitigated"></textarea>
                            <span asp-validation-for="MitigationFactors" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Appraisal Notes -->
                    <h6 class="text-uppercase text-muted mb-3">Appraisal Notes</h6>

                    <div class="mb-4">
                        <label asp-for="AppraisalNotes" class="form-label">Detailed Assessment</label>
                        <textarea asp-for="AppraisalNotes" class="form-control" rows="5"
                                  placeholder="Provide detailed assessment of the loan application" required></textarea>
                        <span asp-validation-for="AppraisalNotes" class="text-danger"></span>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Submit Appraisal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/gauge-chart"></script>
    <script>
        $(document).ready(function() {
            $('#appraisalForm').on('submit', function() {
                var $btn = $(this).find('button[type="submit"]');
                $btn.prop('disabled', true);
                $btn.html('<i class="bi bi-spinner spin me-2"></i>Processing...');
                return true;
            });






            var gauge = new Gauge(document.getElementById('creditScoreMeter')).setOptions({
                angle: 0.15,
                lineWidth: 0.44,
                radiusScale: 1,
                pointer: {
                    length: 0.6,
                    strokeWidth: 0.035,
                    color: '#000000'
                },
                limitMax: true,
                limitMin: true,
                colorStart: '#6FADCF',
                colorStop: '#8FC0DA',
                strokeColor: '#E0E0E0',
                generateGradient: true,
                highDpiSupport: true
            });
            gauge.maxValue = 850;
            gauge.setMinValue(300);

            // Calculate credit score based on inputs
            function calculateCreditScore() {
                var baseScore = 600;
                var shares = parseFloat($('#MemberSharesValue').val()) || 0;
                var deposits = parseFloat($('#MemberDepositsValue').val()) || 0;
                var income = parseFloat($('#MonthlyIncome').val()) || 0;
                var obligations = parseFloat($('#ExistingLoanObligations').val()) || 0;

                // Add points for savings
                if (shares > 100000) baseScore += 50;
                else if (shares > 50000) baseScore += 30;
                else if (shares > 10000) baseScore += 20;

                // Add points for deposits
                if (deposits > 50000) baseScore += 30;
                else if (deposits > 20000) baseScore += 20;
                else if (deposits > 5000) baseScore += 10;

                // Income to obligation ratio
                if (income > 0) {
                    var dti = (obligations / income) * 100;
                    if (dti < 30) baseScore += 40;
                    else if (dti < 50) baseScore += 20;
                    else if (dti < 70) baseScore -= 20;
                    else baseScore -= 50;
                }

                return Math.min(850, Math.max(300, baseScore));
            }

            function updateCreditScore() {
                var score = calculateCreditScore();
                $('#creditScore').text(score);
                gauge.set(score);

                var rating = '';
                var ratingClass = '';
                if (score >= 750) {
                    rating = 'Excellent';
                    ratingClass = 'risk-low';
                } else if (score >= 650) {
                    rating = 'Good';
                    ratingClass = 'risk-low';
                } else if (score >= 550) {
                    rating = 'Fair';
                    ratingClass = 'risk-medium';
                } else {
                    rating = 'Poor';
                    ratingClass = 'risk-high';
                }

                $('#creditRating').text(rating).attr('class', ratingClass + ' p-2 rounded');
            }

            // Update credit score on input change
            $('#MemberSharesValue, #MemberDepositsValue, #MonthlyIncome, #ExistingLoanObligations').on('input', updateCreditScore);

            // Set default values
            $('#MemberSharesValue').val(@(member?.ShareCap?.ToString("0.00") ?? "0"));
            $('#MemberDepositsValue').val(0);
            $('#MonthlyIncome').val(@(member?.MonthlyContr?.ToString("0.00") ?? "0"));
            $('#ExistingLoanObligations').val(0);

            updateCreditScore();

            // Handle decision selection
            $('#decisionSelect').on('change', function() {
                var decision = $(this).val();
                if (decision === 'NotRecommend') {
                    $('#RecommendedAmount, #RecommendedInterestRate, #RecommendedPeriod').prop('disabled', true);
                } else {
                    $('#RecommendedAmount, #RecommendedInterestRate, #RecommendedPeriod').prop('disabled', false);
                }
            });
        });
    </script>
}