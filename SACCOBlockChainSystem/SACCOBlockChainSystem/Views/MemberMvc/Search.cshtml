@{
    ViewData["Title"] = "Search Members";
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-search mr-2"></i>Advanced Member Search
        </h1>
        <a href="@Url.Action("Index")" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Back to List
        </a>
    </div>

    <!-- Search Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-filter mr-2"></i>Search Filters
            </h6>
        </div>
        <div class="card-body">
            <form id="searchForm" method="get" action="@Url.Action("Index")">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Member Number</label>
                            <input type="text" class="form-control" name="memberNo"
                                   placeholder="Enter member number">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>ID Number</label>
                            <input type="text" class="form-control" name="idNo"
                                   placeholder="Enter ID number">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="text" class="form-control" name="phone"
                                   placeholder="Enter phone number">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" class="form-control" name="name"
                                   placeholder="Enter name (surname or other names)">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" name="email"
                                   placeholder="Enter email address">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Company</label>
                            <select class="form-control" name="companyCode">
                                <option value="">All Companies</option>
                                <!-- Populate with companies -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" name="status">
                                <option value="">All Status</option>
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                                <option value="2">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Membership Type</label>
                            <select class="form-control" name="membershipType">
                                <option value="">All Types</option>
                                <option value="Individual">Individual</option>
                                <option value="Corporate">Corporate</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Date Joined (From)</label>
                            <input type="date" class="form-control" name="dateFrom">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Date Joined (To)</label>
                            <input type="date" class="form-control" name="dateTo">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>Advanced Search</label>
                            <input type="text" class="form-control" id="advancedSearch"
                                   placeholder="Search across all fields...">
                            <small class="form-text text-muted">
                                Enter keywords to search across all member fields
                            </small>
                        </div>
                    </div>
                </div>

                <div class="form-group mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                    <button type="reset" class="btn btn-secondary ml-2">
                        <i class="fas fa-redo mr-2"></i>Reset
                    </button>
                    <button type="button" class="btn btn-outline-info ml-2" id="saveSearchBtn">
                        <i class="fas fa-save mr-2"></i>Save Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Search Results -->
    <div class="card shadow d-none" id="searchResultsCard">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list mr-2"></i>Search Results
                <span id="resultsCount" class="badge badge-primary ml-2">0</span>
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="searchResultsTable">
                    <thead>
                        <tr>
                            <th>Member No</th>
                            <th>Name</th>
                            <th>ID Number</th>
                            <th>Phone</th>
                            <th>Company</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Results will be loaded here via AJAX -->
                    </tbody>
                </table>
            </div>
            <div id="loadingSpinner" class="text-center py-5 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-3">Searching members...</p>
            </div>
            <div id="noResults" class="text-center py-5 d-none">
                <i class="fas fa-search fa-3x text-gray-300 mb-3"></i>
                <h5 class="text-gray-500">No Members Found</h5>
                <p class="text-gray-500">Try adjusting your search criteria</p>
            </div>
        </div>
    </div>

    <!-- Saved Searches -->
    <div class="card shadow mt-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-bookmark mr-2"></i>Saved Searches
            </h6>
        </div>
        <div class="card-body">
            <div id="savedSearches">
                <p class="text-muted">No saved searches yet.</p>
            </div>
        </div>
    </div>
</div>

<!-- Save Search Modal -->
<div class="modal fade" id="saveSearchModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Search</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="searchName">Search Name</label>
                    <input type="text" class="form-control" id="searchName"
                           placeholder="e.g., Active Corporate Members">
                </div>
                <div class="form-group">
                    <label for="searchDescription">Description (Optional)</label>
                    <textarea class="form-control" id="searchDescription" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveSearch">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Auto-search on input
            let searchTimeout;
            $('#advancedSearch').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 500);
            });

            // Perform search
            function performSearch() {
                var formData = $('#searchForm').serialize();

                $('#searchResultsCard').removeClass('d-none');
                $('#loadingSpinner').removeClass('d-none');
                $('#searchResultsTable tbody').empty();
                $('#noResults').addClass('d-none');

                $.ajax({
                    url: '@Url.Action("SearchMembersAjax", "MemberMvc")',
                    method: 'GET',
                    data: formData,
                    success: function(response) {
                        $('#loadingSpinner').addClass('d-none');

                        if (response.success && response.data && response.data.length > 0) {
                            $('#resultsCount').text(response.data.length);

                            response.data.forEach(function(member) {
                                var row = `
                                    <tr>
                                        <td><strong>${member.memberNo}</strong></td>
                                        <td>${member.surname} ${member.otherNames}</td>
                                        <td>${member.idno || '-'}</td>
                                        <td>${member.phoneNo || '-'}</td>
                                        <td>${member.companyCode || '-'}</td>
                                        <td>
                                            ${member.status == 1 ?
                                                '<span class="badge badge-success">Active</span>' :
                                                '<span class="badge badge-warning">Inactive</span>'}
                                        </td>
                                        <td>
                                            <a href="/MemberMvc/Details/${member.memberNo}"
                                               class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                `;
                                $('#searchResultsTable tbody').append(row);
                            });
                        } else {
                            $('#noResults').removeClass('d-none');
                            $('#resultsCount').text('0');
                        }
                    },
                    error: function() {
                        $('#loadingSpinner').addClass('d-none');
                        toastr.error('Error performing search');
                    }
                });
            }

            // Save search
            $('#saveSearchBtn').click(function() {
                $('#saveSearchModal').modal('show');
            });

            $('#confirmSaveSearch').click(function() {
                var searchName = $('#searchName').val();
                if (!searchName) {
                    toastr.warning('Please enter a search name');
                    return;
                }

                var searchData = {
                    name: searchName,
                    description: $('#searchDescription').val(),
                    filters: $('#searchForm').serializeArray()
                };

                // Save to localStorage
                var savedSearches = JSON.parse(localStorage.getItem('memberSearches') || '[]');
                savedSearches.push(searchData);
                localStorage.setItem('memberSearches', JSON.stringify(savedSearches));

                $('#saveSearchModal').modal('hide');
                toastr.success('Search saved successfully');
                loadSavedSearches();
            });

            // Load saved searches
            function loadSavedSearches() {
                var savedSearches = JSON.parse(localStorage.getItem('memberSearches') || '[]');
                var container = $('#savedSearches');

                if (savedSearches.length === 0) {
                    container.html('<p class="text-muted">No saved searches yet.</p>');
                    return;
                }

                var html = '<div class="row">';
                savedSearches.forEach(function(search, index) {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">${search.name}</h6>
                                    <p class="card-text small text-muted">${search.description || 'No description'}</p>
                                    <button class="btn btn-sm btn-outline-primary load-search" data-index="${index}">
                                        <i class="fas fa-play mr-1"></i>Load
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger ml-1 delete-search" data-index="${index}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.html(html);

                // Attach event listeners
                $('.load-search').click(function() {
                    var index = $(this).data('index');
                    loadSearch(index);
                });

                $('.delete-search').click(function() {
                    var index = $(this).data('index');
                    deleteSearch(index);
                });
            }

            // Load a saved search
            function loadSearch(index) {
                var savedSearches = JSON.parse(localStorage.getItem('memberSearches') || '[]');
                var search = savedSearches[index];

                if (search) {
                    // Populate form with saved filters
                    search.filters.forEach(function(filter) {
                        $(`[name="${filter.name}"]`).val(filter.value);
                    });

                    toastr.success(`Search "${search.name}" loaded`);
                    performSearch();
                }
            }

            // Delete a saved search
            function deleteSearch(index) {
                if (confirm('Are you sure you want to delete this saved search?')) {
                    var savedSearches = JSON.parse(localStorage.getItem('memberSearches') || '[]');
                    savedSearches.splice(index, 1);
                    localStorage.setItem('memberSearches', JSON.stringify(savedSearches));
                    loadSavedSearches();
                    toastr.success('Search deleted');
                }
            }

            // Initialize
            loadSavedSearches();

            // Perform search on form submit
            $('#searchForm').submit(function(e) {
                e.preventDefault();
                performSearch();
            });
        });
    </script>
}