@model SACCOBlockChainSystem.Services.LoanPortfolioDTO
@{
    ViewData["Title"] = "Loan Portfolio Report";
}

<div class="card">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-graph-up"></i> Loan Portfolio Report</h4>
    </div>
    <div class="card-body">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Loans</h5>
                        <h2 class="card-text">@Model.TotalLoans</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Active Loans</h5>
                        <h2 class="card-text">@Model.ActiveLoans</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h5 class="card-title">Pending Loans</h5>
                        <h2 class="card-text">@Model.PendingLoans</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Balance</h5>
                        <h2 class="card-text">@Model.TotalLoanBalance.ToString("C")</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-pie-chart"></i> Loan Type Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="loanTypeChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-bar-chart"></i> Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-table"></i> Portfolio Statistics</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th class="text-end">Value</th>
                                    <th class="text-end">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Total Loan Amount</td>
                                    <td class="text-end">@Model.TotalLoanAmount.ToString("C")</td>
                                    <td class="text-end">100%</td>
                                </tr>
                                <tr>
                                    <td>Total Outstanding Balance</td>
                                    <td class="text-end">@Model.TotalLoanBalance.ToString("C")</td>
                                    <td class="text-end">@((Model.TotalLoanBalance / Model.TotalLoanAmount * 100).ToString("F1"))%</td>
                                </tr>
                                <tr>
                                    <td>Total Interest Accrued</td>
                                    <td class="text-end">@Model.TotalInterestAccrued.ToString("C")</td>
                                    <td class="text-end">@((Model.TotalInterestAccrued / Model.TotalLoanAmount * 100).ToString("F1"))%</td>
                                </tr>
                                <tr>
                                    <td>Average Loan Amount</td>
                                    <td class="text-end">@((Model.TotalLoans > 0 ? Model.TotalLoanAmount / Model.TotalLoans : 0).ToString("C"))</td>
                                    <td class="text-end">-</td>
                                </tr>
                                <tr>
                                    <td>Active Loan Ratio</td>
                                    <td class="text-end">@Model.ActiveLoans / @Model.TotalLoans</td>
                                    <td class="text-end">@((Model.TotalLoans > 0 ? (decimal)Model.ActiveLoans / Model.TotalLoans * 100 : 0).ToString("F1"))%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> Portfolio Health</h5>
                    </div>
                    <div class="card-body">
                        @{
                            var healthScore = 0;
                            var healthColor = "success";
                            var healthMessage = "";

                            if (Model.TotalLoans > 0)
                            {
                                var activeRatio = (decimal)Model.ActiveLoans / Model.TotalLoans;
                                var balanceRatio = Model.TotalLoanBalance / Model.TotalLoanAmount;

                                if (activeRatio > 0.8m && balanceRatio < 0.3m)
                                {
                                    healthScore = 90;
                                    healthColor = "success";
                                    healthMessage = "Excellent - High performing portfolio";
                                }
                                else if (activeRatio > 0.6m && balanceRatio < 0.5m)
                                {
                                    healthScore = 70;
                                    healthColor = "info";
                                    healthMessage = "Good - Healthy portfolio";
                                }
                                else if (activeRatio > 0.4m && balanceRatio < 0.7m)
                                {
                                    healthScore = 50;
                                    healthColor = "warning";
                                    healthMessage = "Fair - Needs monitoring";
                                }
                                else
                                {
                                    healthScore = 30;
                                    healthColor = "danger";
                                    healthMessage = "Poor - Requires attention";
                                }
                            }
                        }

                        <div class="text-center">
                            <div class="display-1 text-@healthColor">@healthScore</div>
                            <div class="h4 text-@healthColor">Portfolio Score</div>
                            <div class="alert alert-@healthColor mt-3">
                                <i class="bi bi-info-circle"></i> @healthMessage
                            </div>
                        </div>

                        <div class="mt-4">
                            <h6>Key Indicators:</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Active Loans:</span>
                                    <span class="badge bg-success">@Model.ActiveLoans</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Default Risk:</span>
                                    <span class="badge bg-warning">Low</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Collection Rate:</span>
                                    <span class="badge bg-info">95%</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export and Actions -->
        <div class="d-flex justify-content-between mt-4">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            <div>
                <button class="btn btn-outline-success" onclick="exportReport('excel')">
                    <i class="bi bi-file-earmark-excel"></i> Export Report
                </button>
                <button class="btn btn-outline-primary ms-2" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print Report
                </button>
                <button class="btn btn-primary ms-2" onclick="refreshReport()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function() {
            // Loan Type Distribution Chart
            const loanTypeCtx = document.getElementById('loanTypeChart').getContext('2d');
            const loanTypeChart = new Chart(loanTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: [
                        @foreach (var item in Model.LoanTypeDistribution)
                        {
                                <text>'@item.Key',</text>
                        }
                    ],
                    datasets: [{
                        data: [
                            @foreach (var item in Model.LoanTypeDistribution)
                            {
                                    <text>@item.Value,</text>
                            }
                        ],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Status Distribution Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const statusChart = new Chart(statusCtx, {
                type: 'bar',
                data: {
                    labels: ['Pending', 'Guarantors', 'Appraisal', 'Endorsement', 'Approved', 'Disbursed', 'Rejected', 'Closed'],
                    datasets: [{
                        label: 'Number of Loans',
                        data: [
                            @Model.StatusDistribution.GetValueOrDefault(1, 0),
                            @Model.StatusDistribution.GetValueOrDefault(2, 0),
                            @Model.StatusDistribution.GetValueOrDefault(3, 0),
                            @Model.StatusDistribution.GetValueOrDefault(4, 0),
                            @Model.StatusDistribution.GetValueOrDefault(5, 0),
                            @Model.StatusDistribution.GetValueOrDefault(6, 0),
                            @Model.StatusDistribution.GetValueOrDefault(7, 0),
                            @Model.StatusDistribution.GetValueOrDefault(8, 0)
                        ],
                        backgroundColor: [
                            '#FFC107', '#17A2B8', '#6F42C1', '#FD7E14',
                            '#28A745', '#007BFF', '#DC3545', '#6C757D'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        });

        function exportReport(format) {
            alert('Exporting report to ' + format.toUpperCase() + '...');
            // Implementation would generate and download the report
        }

        function refreshReport() {
            location.reload();
        }
    </script>
}