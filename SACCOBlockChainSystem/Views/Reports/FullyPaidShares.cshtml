@using System.Security.Claims
@model SACCOBlockChainSystem.Models.ViewModels.FullyPaidSharesIndexViewModel
@{
    ViewData["Title"] = "Fully Paid Shares Register";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var hasData = Model != null && Model.Members != null && Model.Members.Any();
    var reportDate = Model?.ReportDate ?? (ViewBag.ReportDate as DateTime? ?? DateTime.Now);
    var companyName = Model?.CompanyName ?? ViewBag.CompanyName ?? "";
}

<style media="print">
    .app-sidebar, .app-header, .main-footer, .sidebar-wrapper, .navbar,
    .breadcrumb, .footer, [data-lte-toggle="sidebar"], .brand-link,
    .sidebar-footer, .no-print {
        display: none !important;
    }

    .app-main, .app-content, .content-wrapper, .main-content {
        margin-left: 0 !important;
        padding: 20px !important;
        width: 100% !important;
    }

    .card {
        border: none !important;
        box-shadow: none !important;
    }

    .card-header {
        background-color: #28a745 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .table {
        width: 100% !important;
        border-collapse: collapse !important;
    }

        .table th {
            background-color: #f2f2f2 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

    .btn, .export-buttons, #exportExcelBtn, #exportPdfBtn {
        display: none !important;
    }

    body {
        background: white !important;
        font-size: 11pt;
    }

    .bg-success {
        background-color: #28a745 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
</style>

<div class="card">
    <div class="card-header bg-success text-white">
        <h3 class="card-title">
            <i class="fas fa-check-circle me-2"></i>Fully Paid Shares Register
        </h3>
       
    </div>

    <div class="card-body">
        <!-- Filter Section - Hidden when printing -->
        <div class="row mb-4 no-print">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Report Date</h5>
                    </div>
                    <div class="card-body">
                        <form asp-action="FullyPaidShares" method="post" id="reportForm">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">As At Date</label>
                                        <input type="date" name="reportDate" id="reportDate"
                                               class="form-control"
                                               value="@reportDate.ToString("yyyy-MM-dd")"
                                               required />
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label class="form-label fw-bold">&nbsp;</label>
                                        <div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-search me-1"></i>Generate Report
                                            </button>
                                            <button type="button" class="btn btn-success" id="exportExcelBtn" onclick="exportToExcel(); return false;">
                                                <i class="fas fa-file-excel me-1"></i>Excel
                                            </button>
                                            <button type="button" class="btn btn-danger" id="exportPdfBtn" onclick="exportToPdf(); return false;">
                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                            </button>
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <!-- Export Forms -->
                        <form asp-action="ExportFullyPaidSharesToExcel" method="post" id="excelForm" style="display:none;">
                            <input type="hidden" name="reportDate" id="excelReportDate" />
                        </form>
                        <form asp-action="ExportFullyPaidSharesToPdf" method="post" id="pdfForm" style="display:none;">
                            <input type="hidden" name="reportDate" id="pdfReportDate" />
                        </form>
                    </div>
                </div>
            </div>
        </div>

        @if (hasData)
        {
            <!-- SACCO Header -->
            <div class="text-center mb-4">
                <h2 class="display-6 fw-bold">@companyName.ToUpper()</h2>
                <h4 class="text-muted">FULLY PAID SACCO SHARES AS AT @reportDate.ToString("dd/MM/yyyy")</h4>
                <hr class="my-3" />
            </div>

            <!-- Requirements Summary -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Requirements:</strong>
                        Minimum Share Capital: Minimum Amount basing on Sacco parameters |
                        Registration Fee: Minimum Amount basing on Sacco parameters |
                        Must have Savings/Deposits
                    </div>
                </div>
            </div>

            <!-- Members Table - Exactly as in the image -->
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover" id="membersTable">
                    <thead class="bg-light">
                        <tr>
                            <th width="50">#</th>
                            <th>MEMBERNO</th>
                            <th>NAMES</th>
                            <th>SEX</th>
                            <th class="text-end">SHARE CAPITAL</th>
                            <th class="text-end">SAVINGS/DEPOSITS</th>
                            <th class="text-end">REGISTRATION FEE</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int counter = 1;
                        }
                        @foreach (var item in Model.Members)
                        {
                            <tr>
                                <td class="text-center">@counter</td>
                                <td>@item.MemberNo</td>
                                <td>@item.FullName</td>
                                <td>@item.Sex</td>
                                <td class="text-end">@item.ShareCapital.ToString("N2")</td>
                                <td class="text-end">@item.SavingsDeposits.ToString("N2")</td>
                                <td class="text-end">@item.RegistrationFee.ToString("N2")</td>
                            </tr>
                            counter++;
                        }
                    </tbody>
                    <tfoot class="bg-light fw-bold">
                        <tr>
                            <td colspan="4" class="text-end">GRAND TOTAL:</td>
                            <td class="text-end text-primary">@Model.TotalShareCapital.ToString("N2")</td>
                            <td class="text-end text-primary">@Model.TotalSavingsDeposits.ToString("N2")</td>
                            <td class="text-end text-primary">@Model.TotalRegistrationFee.ToString("N2")</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Statistics Section - Exactly as in the image -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Member Statistics</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <td width="50%"><strong>TOTAL MEMBERS:</strong></td>
                                    <td><strong>@Model.TotalMembers</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>MALE:</strong></td>
                                    <td><strong>@Model.MaleCount.ToString("N0")</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>FEMALE:</strong></td>
                                    <td><strong>@Model.FemaleCount.ToString("N0")</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>OTHERS:</strong></td>
                                    <td><strong>@Model.OtherCount.ToString("N0")</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-coins me-2"></i>Financial Summary</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <td width="50%"><strong>TOTAL SHARE CAPITAL:</strong></td>
                                    <td class="text-end"><strong>@Model.TotalShareCapital.ToString("N2")</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>TOTAL SAVINGS/DEPOSITS:</strong></td>
                                    <td class="text-end"><strong>@Model.TotalSavingsDeposits.ToString("N2")</strong></td>
                                </tr>
                                <tr>
                                    <td><strong>TOTAL REGISTRATION FEE:</strong></td>
                                    <td class="text-end"><strong>@Model.TotalRegistrationFee.ToString("N2")</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Information -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="small text-muted">
                        <i class="fas fa-info-circle"></i>
                        Generated By: @User.Identity.Name on @DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss") |
                        As At: @Model.ReportDate.ToString("dd/MM/yyyy") |
                        Company: @companyName
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info text-center py-5">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h5>No Fully Paid Members Found</h5>
                <p>There are no members who have fully paid their shares as at @reportDate.ToString("dd/MM/yyyy")Select the date and click "Generate Report" to view  data.</p>
                <p class="small">
                    Requirements:
                    Minimum Share Capital: Minimum Amount basing on Sacco parameters
                    Registration Fee: Minimum Amount basing on Sacco parameters |
                    Must have Savings/Deposits
                </p>
            </div>
        }
    </div>
</div>
 
@section Scripts {
    <script>
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';

            // Get all required elements
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const reportDate = document.getElementById('reportDate');
            const excelReportDate = document.getElementById('excelReportDate');
            const pdfReportDate = document.getElementById('pdfReportDate');
            const excelForm = document.getElementById('excelForm');
            const pdfForm = document.getElementById('pdfForm');
            const membersTable = document.getElementById('membersTable');

            // Export to Excel
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', function(e) {
                    e.preventDefault();

                    if (!reportDate) {
                        alert('Report date input not found');
                        return;
                    }

                    const date = reportDate.value;
                    if (!date) {
                        alert('Please select a report date');
                        return;
                    }

                    if (!excelReportDate) {
                        alert('Excel form hidden input not found');
                        return;
                    }

                    if (!excelForm) {
                        alert('Excel form not found');
                        return;
                    }

                    // Set the date value and submit
                    excelReportDate.value = date;
                    excelForm.submit();
                });
            }

            // Export to PDF
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', function(e) {
                    e.preventDefault();

                    if (!reportDate) {
                        alert('Report date input not found');
                        return;
                    }

                    const date = reportDate.value;
                    if (!date) {
                        alert('Please select a report date');
                        return;
                    }

                    if (!pdfReportDate) {
                        alert('PDF form hidden input not found');
                        return;
                    }

                    if (!pdfForm) {
                        alert('PDF form not found');
                        return;
                    }

                    // Set the date value and submit
                    pdfReportDate.value = date;
                    pdfForm.submit();
                });
            }

            // Initialize DataTable if there's data and DataTable is available
            @if (hasData)
            {
                    <text>
                    // Check if DataTable function exists (from jQuery plugin)
                    if (membersTable && typeof $.fn !== 'undefined' && $.fn.DataTable) {
                        try {
                            $(membersTable).DataTable({
                                pageLength: 25,
                                ordering: true,
                                responsive: true,
                                language: {
                                    search: "Search:",
                                    lengthMenu: "Show _MENU_ entries",
                                    info: "Showing _START_ to _END_ of _TOTAL_ entries"
                                }
                            });
                        } catch (error) {
                            console.error('DataTable initialization error:', error);
                        }
                    } else {
                        // Fallback if DataTable is not available
                        console.log('DataTable not available, using standard table');
                    }
                    </text>
            }

            // Also handle the form submission via the Generate Report button
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.addEventListener('submit', function(e) {
                    const date = reportDate.value;
                    if (!date) {
                        e.preventDefault();
                        alert('Please select a report date');
                    }
                });
            }
        });

        // Alternative: Add direct onclick handlers as backup
        (function() {
            // Excel export fallback
            window.exportToExcel = function() {
                const reportDate = document.getElementById('reportDate');
                const excelReportDate = document.getElementById('excelReportDate');
                const excelForm = document.getElementById('excelForm');

                if (!reportDate || !excelReportDate || !excelForm) return;

                const date = reportDate.value;
                if (!date) {
                    alert('Please select a report date');
                    return;
                }

                excelReportDate.value = date;
                excelForm.submit();
            };

            // PDF export fallback
            window.exportToPdf = function() {
                const reportDate = document.getElementById('reportDate');
                const pdfReportDate = document.getElementById('pdfReportDate');
                const pdfForm = document.getElementById('pdfForm');

                if (!reportDate || !pdfReportDate || !pdfForm) return;

                const date = reportDate.value;
                if (!date) {
                    alert('Please select a report date');
                    return;
                }

                pdfReportDate.value = date;
                pdfForm.submit();
            };

            // Add onclick attributes as backup if buttons exist
            document.addEventListener('DOMContentLoaded', function() {
                const excelBtn = document.getElementById('exportExcelBtn');
                const pdfBtn = document.getElementById('exportPdfBtn');

                if (excelBtn && !excelBtn.hasAttribute('onclick')) {
                    excelBtn.setAttribute('onclick', 'exportToExcel(); return false;');
                }

                if (pdfBtn && !pdfBtn.hasAttribute('onclick')) {
                    pdfBtn.setAttribute('onclick', 'exportToPdf(); return false;');
                }
            });
        })();
    </script>
}